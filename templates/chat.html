<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSC 517 TA Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Dark theme (default) */
      --bg: #050816;
      --card: #020617;
      --accent: #6366f1;
      --accent-soft: #1d1b4b;
      --border: #111827;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --bubble-user: linear-gradient(135deg, #4f46e5, #8b5cf6);
      --bubble-ta: #020617;
      --shadow: 0 22px 55px rgba(15,23,42,0.9);
    }

    body.light {
      --bg: #f3f4f6;
      --card: #ffffff;
      --accent: #4f46e5;
      --accent-soft: #e0e7ff;
      --border: #d1d5db;
      --text-main: #111827;
      --text-muted: #6b7280;
      --bubble-user: linear-gradient(135deg, #4f46e5, #8b5cf6);
      --bubble-ta: #f9fafb;
      --shadow: 0 12px 30px rgba(148,163,184,0.4);
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      background-color: var(--bg);
      font-family: system-ui, sans-serif;
      color: var(--text-main);
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    body.light {
      background: var(--bg);
    }

    .app-shell {
      max-width: 980px;
      margin: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100vh;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .title-sub {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 5px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .theme-toggle span.icon {
      font-size: 1rem;
    }

    .chat-card {
      flex: 1;
      background: var(--card);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    .chat-scroll {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 6px;
    }

    .chat-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .chat-scroll::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 999px;
    }

    .msg-row { display: flex; width: 100%; }
    .msg-row.user { justify-content: flex-end; }
    .msg-row.ta { justify-content: flex-start; }

    .bubble {
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 0.94rem;
      line-height: 1.45;
      background: var(--bubble-ta);
      border: 1px solid var(--border);
      position: relative;
      word-wrap: break-word;
    }

    .bubble.user {
      background: var(--bubble-user);
      color: #ffffff;
      border: none;
      border-bottom-right-radius: 4px;
    }

    .bubble.ta {
      border-bottom-left-radius: 4px;
    }

    .bubble-header {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .timestamp {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 4px;
      text-align: right;
    }

    .answer-text {
      margin-bottom: 8px;
      white-space: pre-wrap;
    }

    .feedback-row {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .feedback-btn {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: var(--accent-soft);
      border: none;
      color: var(--text-main);
      cursor: pointer;
    }

    .feedback-btn:hover { filter: brightness(1.1); }

    .section-block {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 0.82rem;
      color: var(--text-muted);
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 9px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .section-header span.label {
      font-weight: 600;
      color: var(--text-main);
    }

    .section-header span.chevron {
      font-size: 0.9rem;
    }

    .section-content {
      padding: 4px 9px 8px;
      border-top: 1px solid var(--border);
      display: none;
    }

    .section-block.open .section-content {
      display: block;
    }

    .section-block.open .section-header span.chevron {
      transform: rotate(90deg);
    }

    .status-line {
      font-size: 0.8rem;
      color: var(--text-muted);
      min-height: 1.1em;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      display: inline-block;
      animation: pulse 1s infinite ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.3; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.1); }
    }

    /* Input area */
    .input-card {
      border-top: 1px solid var(--border);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    textarea, select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px;
      color: var(--text-main);
      resize: vertical;
      font-size: 0.9rem;
    }

    textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .primary-btn {
      padding: 7px 16px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 999px;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .primary-btn:disabled { opacity: 0.55; cursor: default; }
  </style>
</head>
<body>
<div class="app-shell">

  <div class="header-row">
    <div class="title-block">
      <div class="title-main">CSC 517 HITL TA Chatbot</div>
      <div class="title-sub">Ask a question, then rate the TAâ€™s answer, hints, and next steps.</div>
    </div>
    <button id="themeToggle" class="theme-toggle">
      <span class="icon" id="themeIcon">ðŸŒ™</span>
      <span id="themeLabel">Dark</span>
    </button>
  </div>

  <div class="chat-card">
    <div id="chatMessages" class="chat-scroll"></div>

    <div id="statusLine" class="status-line"></div>

    <form id="chatForm" class="input-card">
      <div>
        <label for="question">Question</label>
        <textarea id="question" name="question" rows="3"
                  placeholder="Type a CSC 517 question..." required></textarea>
      </div>

      <div class="controls-row">
        <div style="flex: 1; max-width: 220px;">
          <label for="onboarding_pref">Explanation style</label>
          <select id="onboarding_pref" name="onboarding_pref">
            <option value="concise">Concise</option>
            <option value="step_by_step">Step-by-step</option>
            <option value="deep_dive">Deep dive</option>
          </select>
        </div>
        <button type="submit" id="askBtn" class="primary-btn">Ask TA</button>
      </div>
    </form>
  </div>
</div>

<script>
  const chatMessages = document.getElementById("chatMessages");
  const chatForm = document.getElementById("chatForm");
  const askBtn = document.getElementById("askBtn");
  const statusLine = document.getElementById("statusLine");
  const themeToggle = document.getElementById("themeToggle");
  const themeIcon = document.getElementById("themeIcon");
  const themeLabel = document.getElementById("themeLabel");

  let lastQuestion = "";
  let lastAnswer = "";

  let typingRow = null;  

  function currentTimeString() {
    return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function appendUserMessage(text) {
    const row = document.createElement("div");
    row.className = "msg-row user";

    const bubble = document.createElement("div");
    bubble.className = "bubble user";

    const content = document.createElement("div");
    content.textContent = text;
    bubble.appendChild(content);

    const ts = document.createElement("div");
    ts.className = "timestamp";
    ts.textContent = currentTimeString();
    bubble.appendChild(ts);

    row.appendChild(bubble);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function createSectionBlock(title, contentElement) {
    const block = document.createElement("div");
    block.className = "section-block";

    const header = document.createElement("div");
    header.className = "section-header";

    const label = document.createElement("span");
    label.className = "label";
    label.textContent = title;

    const chevron = document.createElement("span");
    chevron.className = "chevron";
    chevron.textContent = "â€º";

    header.appendChild(label);
    header.appendChild(chevron);

    const content = document.createElement("div");
    content.className = "section-content";
    content.appendChild(contentElement);

    header.onclick = () => {
      block.classList.toggle("open");
    };

    block.appendChild(header);
    block.appendChild(content);
    return block;
  }

  function appendTAMessage(answer, hint, reflectionQuestions, nextStep) {
    // remove typing row if present
    if (typingRow && typingRow.parentNode) {
      typingRow.parentNode.removeChild(typingRow);
      typingRow = null;
    }

    const row = document.createElement("div");
    row.className = "msg-row ta";

    const bubble = document.createElement("div");
    bubble.className = "bubble ta";

    const header = document.createElement("div");
    header.className = "bubble-header";
    header.textContent = "TA answer";
    bubble.appendChild(header);

    const answerDiv = document.createElement("div");
    answerDiv.className = "answer-text";
    answerDiv.textContent = answer;
    bubble.appendChild(answerDiv);

    // Feedback row directly under answer
    const fbRow = document.createElement("div");
    fbRow.className = "feedback-row";

    ["helpful", "needs_work", "confusing"].forEach(type => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "feedback-btn";
      btn.dataset.rating = type;

      if (type === "helpful") btn.textContent = "ðŸ‘ Helpful";
      else if (type === "needs_work") btn.textContent = "ðŸ‘Ž Needs work";
      else btn.textContent = "âš ï¸ Confusing";

      fbRow.appendChild(btn);
    });

    bubble.appendChild(fbRow);

    // Hint block 
    if (hint) {
      const hintText = document.createElement("div");
      hintText.textContent = hint;
      const hintBlock = createSectionBlock("Hint", hintText);
      hintBlock.classList.add("open"); 
      bubble.appendChild(hintBlock);
    }

    // Reflection (collapsible)
    if (reflectionQuestions && reflectionQuestions.length > 0) {
      const list = document.createElement("ul");
      list.style.margin = "4px 0 0";
      list.style.paddingLeft = "18px";
      reflectionQuestions.forEach(q => {
        const li = document.createElement("li");
        li.textContent = q;
        list.appendChild(li);
      });
      const reflBlock = createSectionBlock("Reflection prompts", list);
      bubble.appendChild(reflBlock);
    }

    // Next step (collapsible)
    if (nextStep) {
      const nsText = document.createElement("div");
      nsText.textContent = nextStep;
      const nsBlock = createSectionBlock("Next step suggestion", nsText);
      bubble.appendChild(nsBlock);
    }

    const ts = document.createElement("div");
    ts.className = "timestamp";
    ts.textContent = currentTimeString();
    bubble.appendChild(ts);

    row.appendChild(bubble);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function showTypingIndicator() {
    if (typingRow) return;

    typingRow = document.createElement("div");
    typingRow.className = "msg-row ta";

    const bubble = document.createElement("div");
    bubble.className = "bubble ta";

    const header = document.createElement("div");
    header.className = "bubble-header";
    header.textContent = "TA is typing...";
    bubble.appendChild(header);

    const dots = document.createElement("div");
    dots.innerHTML = '<span class="typing-dot"></span> <span class="typing-dot"></span> <span class="typing-dot"></span>';
    bubble.appendChild(dots);

    typingRow.appendChild(bubble);
    chatMessages.appendChild(typingRow);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function hideTypingIndicator() {
    if (typingRow && typingRow.parentNode) {
      typingRow.parentNode.removeChild(typingRow);
      typingRow = null;
    }
  }

  // Welcome TA message
  function appendWelcomeMessage() {
    const row = document.createElement("div");
    row.className = "msg-row ta";

    const bubble = document.createElement("div");
    bubble.className = "bubble ta";

    const header = document.createElement("div");
    header.className = "bubble-header";
    header.textContent = "TA";
    bubble.appendChild(header);

    const text = document.createElement("div");
    text.className = "answer-text";
    text.textContent =
      "Hi! Iâ€™m the CSC 517 TA chatbot.What do you wanna learn today?";
    bubble.appendChild(text);

    const ts = document.createElement("div");
    ts.className = "timestamp";
    ts.textContent = currentTimeString();
    bubble.appendChild(ts);

    row.appendChild(bubble);
    chatMessages.appendChild(row);
  }

  // Form submit
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const question = document.getElementById("question").value.trim();
    const onboardingPref = document.getElementById("onboarding_pref").value;

    if (!question) return;

    lastQuestion = question;

    appendUserMessage(question);
    document.getElementById("question").value = "";

    askBtn.disabled = true;
    statusLine.innerHTML = '<span class="typing-dot"></span> TA is thinking...';
    showTypingIndicator();

    const formData = new FormData();
    formData.append("question", question);
    formData.append("first_guess", "");  
    formData.append("onboarding_pref", onboardingPref);

    try {
      const res = await fetch("/chat", { method: "POST", body: formData });

      if (!res.ok) throw new Error("Request failed: " + res.status);

      const data = await res.json();
      lastAnswer = data.answer || "";

      appendTAMessage(
        data.answer || "Sorry, I couldn't generate an answer.",
        data.hint || "",
        data.reflection_questions || [],
        data.next_step || ""
      );

      statusLine.textContent = "";
    } catch (err) {
      console.error(err);
      statusLine.textContent = "Error while contacting TA. Please try again.";
      hideTypingIndicator();
    } finally {
      hideTypingIndicator();
      askBtn.disabled = false;
    }
  });


  async function sendFeedback(rating) {
    if (!lastAnswer || !lastQuestion) return;
    try {
      await fetch("/feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          rating,
          question: lastQuestion,
          first_guess: "",
          answer: lastAnswer,
          comment: ""
        })
      });
      statusLine.textContent = "Feedback saved. Thank you!";
      setTimeout(() => {
        if (statusLine.textContent.startsWith("Feedback saved")) {
          statusLine.textContent = "";
        }
      }, 2000);
    } catch (err) {
      console.error(err);
      statusLine.textContent = "Could not save feedback.";
    }
  }

  chatMessages.addEventListener("click", (e) => {
    const btn = e.target.closest(".feedback-btn");
    if (!btn) return;
    const rating = btn.dataset.rating;
    if (rating) sendFeedback(rating);
  });

  
  function applyTheme(theme) {
    if (theme === "light") {
      document.body.classList.add("light");
      themeIcon.textContent = "â˜€ï¸";
      themeLabel.textContent = "Light";
    } else {
      document.body.classList.remove("light");
      themeIcon.textContent = "ðŸŒ™";
      themeLabel.textContent = "Dark";
    }
  }

  function loadTheme() {
    const stored = localStorage.getItem("csc517_theme") || "dark";
    applyTheme(stored);
  }

  themeToggle.addEventListener("click", () => {
    const isLight = document.body.classList.contains("light");
    const newTheme = isLight ? "dark" : "light";
    applyTheme(newTheme);
    localStorage.setItem("csc517_theme", newTheme);
  });

  // On page load
  loadTheme();
  appendWelcomeMessage();
</script>
</body>
</html>
